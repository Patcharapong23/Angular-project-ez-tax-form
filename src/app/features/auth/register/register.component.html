<div class="auth-shell">
  <div class="auth-card">
    <img class="brand" src="assets/logo-ez-tax.svg" alt="EZ Tax Form" />

    <h1 class="title">ลงทะเบียนใช้งานฟรี สำหรับธุรกิจ</h1>
    <p class="subtitle">
      เพื่อการใช้งานที่ครบถ้วนสมบูรณ์
      กรุณาให้ข้อมูลสำหรับสร้างบัญชีการใช้งานระบบ
    </p>

    <form [formGroup]="form" (ngSubmit)="onSubmit()">
      <!-- STEP 1 ------------------------------------------------------------>
      <div *ngIf="step === 1" class="step-panel">
        <!-- firstName: พิมพ์ได้ทั้งไทยและอังกฤษ -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>ชื่อ-นามสกุล</mat-label>
          <input
            matInput
            formControlName="firstName"
            autocomplete="name"
            [attr.maxlength]="firstNameMaxLen"
          />
          <span matSuffix class="dropdown-caret" aria-hidden="true">
            <i class="ti ti-user"></i>
          </span>
          <mat-error *ngIf="firstName?.hasError('required')"
            >กรุณากรอกชื่อ-นามสกุล</mat-error
          >
          <mat-error *ngIf="firstName?.hasError('minlength')"
            >อย่างน้อย 2 ตัวอักษร</mat-error
          >
        </mat-form-field>

        <!-- email -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>อีเมล</mat-label>
          <input
            matInput
            type="email"
            formControlName="email"
            [attr.maxlength]="emailMaxLen"
            autocomplete="email"
            inputmode="email"
            spellcheck="false"
            (keydown)="blockThai($event)"
          />
          <span matSuffix class="dropdown-caret" aria-hidden="true">
            <i class="ti ti-mail"></i>
          </span>
          <mat-error *ngIf="email?.hasError('required')"
            >กรุณากรอกอีเมล</mat-error
          >
          <mat-error *ngIf="email?.hasError('maxlength')"
            >อีเมลยาวเกิน {{ emailMaxLen }} ตัวอักษร</mat-error
          >
          <mat-error
            *ngIf="email?.hasError('pattern') || email?.hasError('email')"
          >
            รูปแบบอีเมลไม่ถูกต้อง (ตัวอย่าง: name@example.com)
          </mat-error>
          <mat-error *ngIf="email?.hasError('nonAscii')">
            ห้ามใช้อักขระภาษาไทยหรืออักขระที่อยู่นอก ASCII ในอีเมล
          </mat-error>
        </mat-form-field>

        <!-- userName อัตโนมัติจากอีเมล -->
        <p class="tiny-hint">
          ชื่อผู้ใช้ (จะถูกสร้างอัตโนมัติ):
          <strong>{{ (email?.value || "").split("@")[0] }}</strong>
        </p>

        <div class="actions">
          <button
            class="button"
            mat-raised-button
            color="primary"
            type="button"
            (click)="onContinue()"
          >
            ดำเนินการต่อ
          </button>
        </div>
      </div>

      <!-- STEP 2 ------------------------------------------------------------>
      <div *ngIf="step === 2" class="step-panel" formGroupName="company">
        <!-- Upload logo -->
        <div
          class="upload-box"
          [class.has-image]="logoPreview"
          (click)="logoInput.click()"
        >
          <input
            #logoInput
            type="file"
            accept="image/*"
            (change)="onLogoSelected($event)"
          />
          <img
            *ngIf="logoPreview"
            class="logo-preview"
            [src]="logoPreview"
            alt="Logo Preview"
          />
          <label class="upload-trigger">Choose Logo File</label>
        </div>
        <p class="upload-note">
          ขนาดภาพที่แนะนำ 300 × 300 px และขนาดไม่เกิน 10 MB
        </p>

        <h3 class="section-title">ข้อมูลบริษัท <span class="req">*</span></h3>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>ชื่อบริษัท (ภาษาไทย)</mat-label>
          <input matInput formControlName="tenantNameTh" />
          <span matSuffix class="dropdown-caret" aria-hidden="true"
            ><i class="ti ti-building-skyscraper"></i
          ></span>
          <mat-error *ngIf="company.get('tenantNameTh')?.hasError('required')"
            >กรุณากรอกชื่อบริษัท (ภาษาไทย)</mat-error
          >
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>ชื่อบริษัท (ภาษาอังกฤษ)</mat-label>
          <input matInput formControlName="tenantNameEn" />
          <span matSuffix class="dropdown-caret" aria-hidden="true"
            ><i class="ti ti-building"></i
          ></span>
        </mat-form-field>

        <div class="grid-2">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>รหัสสาขา 5 หลัก</mat-label>
            <input
              matInput
              maxlength="5"
              formControlName="branchCode"
              inputmode="numeric"
              (keydown)="onlyDigitsKeydown($event)"
              (input)="sanitizeDigits($event, company.get('branchCode'))"
            />
            <span matSuffix class="dropdown-caret" aria-hidden="true"
              ><i class="ti ti-building-bank"></i
            ></span>
            <mat-error *ngIf="company.get('branchCode')?.hasError('required')"
              >กรุณากรอกรหัสสาขา</mat-error
            >
            <mat-error
              *ngIf="
                company.get('branchCode')?.hasError('minlength') ||
                company.get('branchCode')?.hasError('maxlength')
              "
            >
              ต้องเป็นตัวเลข 5 หลัก
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>ชื่อสาขา (ภาษาไทย)</mat-label>
            <input matInput formControlName="branchNameTh" />
            <span matSuffix class="dropdown-caret" aria-hidden="true"
              ><i class="ti ti-building-warehouse"></i
            ></span>
            <mat-error *ngIf="company.get('branchNameTh')?.hasError('required')"
              >กรุณากรอกชื่อสาขา (ภาษาไทย)</mat-error
            >
          </mat-form-field>
        </div>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>ชื่อสาขา (อังกฤษ)</mat-label>
          <input matInput formControlName="branchNameEn" />
          <span matSuffix class="dropdown-caret" aria-hidden="true"
            ><i class="ti ti-building-arch"></i
          ></span>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>เลขประจำตัวผู้เสียภาษีอากร 13 หลัก</mat-label>
          <input
            matInput
            maxlength="13"
            formControlName="tenantTaxId"
            inputmode="numeric"
            (keydown)="onlyDigitsKeydown($event)"
            (input)="sanitizeDigits($event, company.get('tenantTaxId'))"
          />
          <span matSuffix class="dropdown-caret" aria-hidden="true"
            ><i class="ti ti-file-certificate"></i
          ></span>
          <mat-error *ngIf="company.get('tenantTaxId')?.hasError('required')"
            >กรุณากรอกเลขประจำตัวผู้เสียภาษีอากร</mat-error
          >
          <mat-error
            *ngIf="
              company.get('tenantTaxId')?.hasError('minlength') ||
              company.get('tenantTaxId')?.hasError('maxlength')
            "
          >
            ต้องเป็นตัวเลข 13 หลัก
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>เบอร์ติดต่อธุรกิจ</mat-label>
          <input
            matInput
            formControlName="tenantTel"
            inputmode="numeric"
            (keydown)="onlyDigitsKeydown($event)"
            (input)="sanitizeDigits($event, company.get('tenantTel'))"
          />
          <span matSuffix class="dropdown-caret" aria-hidden="true"
            ><i class="ti ti-phone"></i
          ></span>
        </mat-form-field>

        <h3 class="section-title">
          ที่อยู่ (ภาษาไทย) <span class="req">*</span>
        </h3>

        <div formGroupName="addressTh">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>เลขที่อาคาร</mat-label>
            <input matInput formControlName="buildingNo" />
            <span matSuffix class="dropdown-caret" aria-hidden="true"
              ><i class="ti ti-home"></i
            ></span>
            <mat-error *ngIf="addressTh.get('buildingNo')?.hasError('required')"
              >กรุณากรอกเลขที่อาคาร</mat-error
            >
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>ชื่ออาคาร/ชั้นที่/ซอย/ถนน (ภาษาไทย)</mat-label>
            <input matInput formControlName="addressDetailTh" />
            <span matSuffix class="dropdown-caret" aria-hidden="true"
              ><i class="ti ti-road"></i
            ></span>
          </mat-form-field>

          <!-- จังหวัด -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>จังหวัด</mat-label>
            <input
              matInput
              type="text"
              formControlName="province"
              [matAutocomplete]="autoProv"
              #provTrig="matAutocompleteTrigger"
              (focus)="onProvinceFocus(provTrig)"
              (input)="onProvinceInput($any($event.target).value)"
              (blur)="fixProvinceDisplay()"
            />
            <span matSuffix class="dropdown-caret" aria-hidden="true"
              ><i class="ti ti-chevron-down"></i
            ></span>
            <mat-autocomplete
              #autoProv="matAutocomplete"
              [displayWith]="displayProvince.bind(this)"
              autoActiveFirstOption
              (optionSelected)="onProvinceSelected($event.option.value)"
            >
              <mat-option *ngFor="let p of filteredProvinces" [value]="p">{{
                p.name_th
              }}</mat-option>
            </mat-autocomplete>
            <mat-error *ngIf="addressTh.get('province')?.hasError('required')"
              >กรุณาเลือกจังหวัด</mat-error
            >
          </mat-form-field>

          <div class="grid-2">
            <!-- อำเภอ -->
            <mat-form-field
              appearance="outline"
              class="full-width mf-relative"
              [class.blocked]="isDistrictLocked"
            >
              <div
                class="field-blocker"
                *ngIf="isDistrictLocked"
                title="กรุณาเลือกจังหวัดก่อน"
              ></div>
              <mat-label>เขต/อำเภอ</mat-label>
              <input
                matInput
                type="text"
                formControlName="district"
                [matAutocomplete]="autoDist"
                #distTrig="matAutocompleteTrigger"
                [readonly]="isDistrictLocked"
                [disabled]="isDistrictLocked"
                [attr.tabindex]="isDistrictLocked ? -1 : 0"
                (focus)="onDistrictFocus(distTrig)"
                (input)="onDistrictType($any($event.target).value)"
                (blur)="fixDistrictDisplay()"
              />
              <span matSuffix class="dropdown-caret" aria-hidden="true"
                ><i class="ti ti-chevron-down"></i
              ></span>
              <mat-autocomplete
                #autoDist="matAutocomplete"
                [displayWith]="displayDistrict.bind(this)"
                autoActiveFirstOption
                (optionSelected)="onDistrictSelected($event.option.value)"
              >
                <mat-option *ngFor="let d of filteredDistricts" [value]="d">{{
                  d.name_th
                }}</mat-option>
              </mat-autocomplete>
              <mat-error *ngIf="addressTh.get('district')?.hasError('required')"
                >กรุณาเลือกเขต/อำเภอ</mat-error
              >
            </mat-form-field>

            <!-- ตำบล -->
            <mat-form-field
              appearance="outline"
              class="full-width mf-relative"
              [class.blocked]="isSubdistrictLocked"
            >
              <div
                class="field-blocker"
                *ngIf="isSubdistrictLocked"
                title="กรุณาเลือกอำเภอก่อน"
              ></div>
              <mat-label>แขวง/ตำบล</mat-label>
              <input
                matInput
                type="text"
                formControlName="subdistrict"
                [matAutocomplete]="autoSub"
                #subTrig="matAutocompleteTrigger"
                [readonly]="isSubdistrictLocked"
                [disabled]="isSubdistrictLocked"
                [attr.tabindex]="isSubdistrictLocked ? -1 : 0"
                (focus)="onSubdistrictFocus(subTrig)"
                (input)="onSubdistrictType($any($event.target).value)"
                (blur)="fixSubdistrictDisplay()"
              />
              <span matSuffix class="dropdown-caret" aria-hidden="true"
                ><i class="ti ti-chevron-down"></i
              ></span>
              <mat-autocomplete
                #autoSub="matAutocomplete"
                [displayWith]="displaySubdistrict.bind(this)"
                autoActiveFirstOption
                (optionSelected)="onSubdistrictSelected($event.option.value)"
              >
                <mat-option
                  *ngFor="let s of filteredSubdistricts"
                  [value]="s"
                  >{{ s.name_th }}</mat-option
                >
              </mat-autocomplete>
              <mat-error
                *ngIf="addressTh.get('subdistrict')?.hasError('required')"
                >กรุณาเลือกแขวง/ตำบล</mat-error
              >
            </mat-form-field>
          </div>

          <!-- ZIP -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>รหัสไปรษณีย์</mat-label>
            <input
              matInput
              formControlName="zipCode"
              maxlength="5"
              inputmode="numeric"
              [readonly]="isZipReadOnly"
              (focus)="onZipFocus()"
              (keydown)="onlyDigitsKeydown($event)"
              (input)="sanitizeDigits($event, addressTh.get('zipCode'))"
              (keyup.enter)="onZipEnter()"
            />
            <span matSuffix class="dropdown-caret" aria-hidden="true"
              ><i class="ti ti-mail"></i
            ></span>
            <mat-hint>
              ใส่ให้ครบ 5 หลักหรือกด Enter → ระบบจะพยายามเติม จังหวัด/อำเภอ/ตำบล
              ให้อัตโนมัติ
            </mat-hint>
            <mat-error *ngIf="addressTh.get('zipCode')?.hasError('required')"
              >กรุณากรอกรหัสไปรษณีย์</mat-error
            >
          </mat-form-field>
        </div>

        <h3 class="section-title">ที่อยู่ (ภาษาอังกฤษ)</h3>
        <div formGroupName="addressEn">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>เลขที่อาคาร/ถนน/ซอย (English)</mat-label>
            <input matInput formControlName="addressDetailEn" />
            <span matSuffix class="dropdown-caret" aria-hidden="true"
              ><i class="ti ti-road"></i
            ></span>
          </mat-form-field>
        </div>

        <mat-checkbox formControlName="acceptTos">
          ยอมรับเงื่อนไขและข้อกำหนดการใช้งานระบบ
        </mat-checkbox>
        <div
          class="tiny-error"
          *ngIf="
            company.get('acceptTos')?.hasError('required') &&
            (company.get('acceptTos')?.touched || step2Submitted)
          "
        >
          โปรดยอมรับเงื่อนไขการใช้งาน
        </div>

        <div class="form-error" *ngIf="formServerError">
          {{ formServerError }}
        </div>

        <div class="actions">
          <button
            mat-raised-button
            color="primary"
            type="submit"
            class="button"
            [disabled]="isSubmitting"
          >
            {{ isSubmitting ? "กำลังบันทึก..." : "ลงทะเบียน" }}
          </button>
          <button mat-stroked-button type="button" (click)="onBack()">
            ย้อนกลับ
          </button>
        </div>
      </div>
    </form>

    <p class="foot-note">
      มีบัญชีอยู่แล้ว? <a class="link" routerLink="/login">เข้าสู่ระบบ</a>
    </p>
  </div>
</div>
