<section class="branches-page">
  <!-- HEADER -->
  <div class="page-header">
    <h1>ข้อมูลสาขา</h1>
    <ng-container *hasPermission="'BRANCH_ADD'">
      <button color="primary" (click)="onAddBranch()" class="btn">
        <mat-icon>add</mat-icon> เพิ่มสาขา
      </button>
    </ng-container>
  </div>

  <!-- SEARCH CARD -->
  <div class="search-card">
    <form [formGroup]="searchForm" (ngSubmit)="onSearch()">
      <div class="grid-3">
        <!-- รหัสสาขา -->
        <div class="field">
          <label>รหัสสาขา</label>
          <input
            type="text"
            formControlName="branchCode"
            placeholder="กรอกรหัสสาขา"
          />
        </div>

        <!-- วันที่สร้าง (เริ่มต้น-สิ้นสุด) -->
        <div formGroupName="dateRange" class="date-range-wrapper">
          <label>วันที่สร้าง (เริ่มต้น-สิ้นสุด)</label>

          <!-- กล่องที่เห็นบนจอ -->
          <div
            class="date-display"
            (click)="picker.open()"
            [class.active]="picker.opened"
          >
            <span [class.placeholder]="!dateRangeText">
              {{ dateRangeText || "เลือกวันที่เริ่มต้น - วันที่สิ้นสุด" }}
            </span>
            <mat-icon>event</mat-icon>
          </div>

          <!-- ตัวเก็บค่าที่ซ่อนอยู่ -->
          <mat-date-range-input
            [rangePicker]="picker"
            class="hidden-range-input"
          >
            <input matStartDate formControlName="start" />
            <input matEndDate formControlName="end" />
          </mat-date-range-input>
          <mat-date-range-picker
            #picker
            [panelClass]="'ez-datepicker-panel'"
          ></mat-date-range-picker>
        </div>

        <!-- สถานะ -->
        <div class="field">
          <label>สถานะ</label>
          <div class="custom-dropdown">
            <button
              type="button"
              class="dropdown-trigger"
              (click)="toggleDropdown('status')"
              [class.active]="opened['status']"
            >
              <span
                [class.placeholder]="
                  !selectedStatus?.value && selectedStatus?.value !== ''
                "
              >
                {{ selectedStatus?.name || "เลือกสถานะ" }}
              </span>
              <mat-icon class="dropdown-arrow">expand_more</mat-icon>
            </button>
            <div class="dropdown-panel" [class.open]="opened['status']">
              <button
                type="button"
                *ngFor="let s of statusOptions"
                class="dropdown-option"
                (click)="selectStatus(s)"
              >
                <div class="selected-item">
                  <span>{{ s.name }}</span>
                </div>
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="action-row">
        <div class="grow"></div>
        <button color="primary" type="submit" class="btn">ค้นหา</button>
        <button
          mat-stroked-button
          type="button"
          class="button-clear"
          (click)="onClear()"
        >
          เคลียร์
        </button>
      </div>
    </form>
  </div>

  <!-- TABLE CARD -->
  <div class="table-card">
    <div class="table-responsive">
      <table>
        <thead>
          <tr>
            <th class="text-left sortable" (click)="onSort('branchCode')">
              รหัสสาขา
              <span class="sort-icon-wrapper">
                <i
                  class="ti ti-caret-up-filled"
                  [class.active]="sortBy === 'branchCode' && sortDir === 'asc'"
                ></i>
                <i
                  class="ti ti-caret-down-filled"
                  [class.active]="sortBy === 'branchCode' && sortDir === 'desc'"
                ></i>
              </span>
            </th>
            <th class="text-left sortable" (click)="onSort('branchNameTh')">
              ชื่อสาขา
              <span class="sort-icon-wrapper">
                <i
                  class="ti ti-caret-up-filled"
                  [class.active]="
                    sortBy === 'branchNameTh' && sortDir === 'asc'
                  "
                ></i>
                <i
                  class="ti ti-caret-down-filled"
                  [class.active]="
                    sortBy === 'branchNameTh' && sortDir === 'desc'
                  "
                ></i>
              </span>
            </th>
            <th class="text-left sortable" (click)="onSort('addressDetailTh')">
              ที่อยู่
              <span class="sort-icon-wrapper">
                <i
                  class="ti ti-caret-up-filled"
                  [class.active]="
                    sortBy === 'addressDetailTh' && sortDir === 'asc'
                  "
                ></i>
                <i
                  class="ti ti-caret-down-filled"
                  [class.active]="
                    sortBy === 'addressDetailTh' && sortDir === 'desc'
                  "
                ></i>
              </span>
            </th>
            <th class="text-left sortable" (click)="onSort('createDate')">
              วันที่สร้าง
              <span class="sort-icon-wrapper">
                <i
                  class="ti ti-caret-up-filled"
                  [class.active]="sortBy === 'createDate' && sortDir === 'asc'"
                ></i>
                <i
                  class="ti ti-caret-down-filled"
                  [class.active]="sortBy === 'createDate' && sortDir === 'desc'"
                ></i>
              </span>
            </th>
            <th class="text-left sortable" (click)="onSort('updateDate')">
              วันที่แก้ไข
              <span class="sort-icon-wrapper">
                <i
                  class="ti ti-caret-up-filled"
                  [class.active]="sortBy === 'updateDate' && sortDir === 'asc'"
                ></i>
                <i
                  class="ti ti-caret-down-filled"
                  [class.active]="sortBy === 'updateDate' && sortDir === 'desc'"
                ></i>
              </span>
            </th>
            <th class="text-center sortable" (click)="onSort('enableFlag')">
              สถานะ
              <span class="sort-icon-wrapper">
                <i
                  class="ti ti-caret-up-filled"
                  [class.active]="sortBy === 'enableFlag' && sortDir === 'asc'"
                ></i>
                <i
                  class="ti ti-caret-down-filled"
                  [class.active]="sortBy === 'enableFlag' && sortDir === 'desc'"
                ></i>
              </span>
            </th>
            <th class="text-center">การดำเนินการ</th>
          </tr>
        </thead>

        <tbody>
          <tr *ngFor="let branch of paginatedBranches">
            <td class="text-left">{{ branch.branchCode }}</td>
            <td class="text-left">{{ branch.branchNameTh }}</td>
            <td class="text-left">{{ branch.addressDetailTh }}</td>
            <td class="text-left">
              {{ branch.createDate | thaiDate : "dd/MM/yyyy" }}
            </td>
            <td class="text-left">
              {{ branch.updateDate | thaiDate : "dd/MM/yyyy" }}
            </td>
            <td class="text-center">
              <span
                class="status"
                [ngClass]="branch.enableFlag ? 'active' : 'inactive'"
              >
                {{ branch.enableFlag ? "เปิดใช้งาน" : "ปิดใช้งาน" }}
              </span>
            </td>
            <td class="actions text-center">
              <ng-container *hasPermission="'BRANCH_VIEW'">
                <button
                  mat-icon-button
                  class="icon-view"
                  title="ดู"
                  (click)="onView(branch)"
                >
                  <i class="ti ti-eye"></i>
                </button>
              </ng-container>
              <ng-container *hasPermission="'BRANCH_EDIT'">
                <button
                  mat-icon-button
                  class="icon-edit"
                  title="แก้ไข"
                  (click)="onEdit(branch)"
                >
                  <i class="ti ti-edit"></i>
                </button>
              </ng-container>
              <ng-container *hasPermission="'BRANCH_DELETE'">
                <button
                  mat-icon-button
                  class="icon-delete"
                  title="ลบ"
                  (click)="onDelete(branch)"
                >
                  <i class="ti ti-trash"></i>
                </button>
              </ng-container>
            </td>
          </tr>

          <tr *ngIf="branches.length === 0">
            <td colspan="7" class="no-data">ไม่พบข้อมูลสาขา</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="pagination">
      <div class="pagination-left">
        <div class="items-per-page">
          <span>แสดง</span>
          <select
            (change)="onItemsPerPageChange($event)"
            [value]="itemsPerPage"
          >
            <option value="10">10</option>
            <option value="20">20</option>
            <option value="50">50</option>
          </select>
          <span>รายการ</span>
        </div>

        <div class="pagination-info">
          แสดง {{ startItemIndex }} ถึง {{ endItemIndex }} จาก
          {{ branches.length }} รายการ
        </div>
      </div>

      <div class="pagination-controls">
        <div class="page-number">
          <button
            (click)="onPageChange(currentPage - 1)"
            [disabled]="currentPage === 1"
          >
            <mat-icon>chevron_left</mat-icon>
          </button>

          <button
            *ngFor="let page of pages"
            (click)="onPageChange(page)"
            [class.active]="currentPage === page"
          >
            {{ page }}
          </button>

          <button
            (click)="onPageChange(currentPage + 1)"
            [disabled]="currentPage === totalPages"
          >
            <mat-icon>chevron_right</mat-icon>
          </button>
        </div>
      </div>
    </div>
  </div>
</section>
