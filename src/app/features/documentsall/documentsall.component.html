<section class="page">
  <div
    style="
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    "
  >
    <h1 class="page-title" style="margin: 0">รายการเอกสารทั้งหมด</h1>
    <ng-container *hasPermission="'DOC_CREATE'">
      <button color="primary" (click)="createNewDocument()" class="btn">
        <mat-icon>add</mat-icon> สร้างเอกสารใหม่
      </button>
    </ng-container>
  </div>
  <div class="quick-grid">
    <div class="quick-card placeholder search-card">
      <form [formGroup]="searchForm" (ngSubmit)="search()" class="search-form">
        <div class="grid-3">
          <div class="field">
            <label>เลขที่เอกสาร</label>
            <input type="text" formControlName="docNo" />
          </div>

          <div class="field">
            <label>เลขที่ผู้เสียภาษีผู้ซื้อ</label>
            <input type="text" formControlName="buyerTaxId" />
          </div>

          <div class="field">
            <label>ประเภทเอกสาร</label>
            <div class="custom-dropdown">
              <button
                type="button"
                class="dropdown-trigger"
                (click)="toggleDropdown('docType'); $event.stopPropagation()"
                [class.active]="opened['docType']"
              >
                <span
                  [class.placeholder]="
                    !selectedDocType?.value && selectedDocType?.value !== ''
                  "
                >
                  {{ selectedDocType?.name || "เลือกประเภทเอกสาร" }}
                </span>
                <mat-icon class="dropdown-arrow">expand_more</mat-icon>
              </button>
              <div class="dropdown-panel" [class.open]="opened['docType']">
                <button
                  type="button"
                  *ngFor="let doc of docTypes"
                  class="dropdown-option"
                  (click)="selectDocType(doc)"
                >
                  <div class="selected-item">
                    <span>{{ doc.name }}</span>
                  </div>
                </button>
              </div>
            </div>
          </div>

          <!-- Issue Date Range -->
          <div formGroupName="issueDateRange" class="date-range-wrapper">
            <label>วันที่ออกเอกสาร (เริ่มต้น–สิ้นสุด)</label>
            <div class="date-display" (click)="issuePicker.open()">
              <span [class.placeholder]="!issueDateRangeText">
                {{
                  issueDateRangeText || "เลือกวันที่เริ่มต้น - วันที่สิ้นสุด"
                }}
              </span>
              <mat-icon>event</mat-icon>
            </div>
            <mat-date-range-input
              [rangePicker]="issuePicker"
              class="hidden-range-input"
            >
              <input matStartDate formControlName="start" />
              <input matEndDate formControlName="end" />
            </mat-date-range-input>
            <mat-date-range-picker #issuePicker></mat-date-range-picker>
          </div>

          <!-- Created Date Range -->
          <div formGroupName="createdDateRange" class="date-range-wrapper">
            <label>วันที่สร้างเอกสาร (เริ่มต้น–สิ้นสุด)</label>
            <div class="date-display" (click)="createdPicker.open()">
              <span [class.placeholder]="!createdDateRangeText">
                {{
                  createdDateRangeText || "เลือกวันที่เริ่มต้น - วันที่สิ้นสุด"
                }}
              </span>
              <mat-icon>event</mat-icon>
            </div>
            <mat-date-range-input
              [rangePicker]="createdPicker"
              class="hidden-range-input"
            >
              <input matStartDate formControlName="start" />
              <input matEndDate formControlName="end" />
            </mat-date-range-input>
            <mat-date-range-picker #createdPicker></mat-date-range-picker>
          </div>

          <div class="field">
            <label>สถานะเอกสาร</label>
            <div class="custom-dropdown">
              <button
                type="button"
                class="dropdown-trigger"
                (click)="toggleDropdown('status'); $event.stopPropagation()"
                [class.active]="opened['status']"
              >
                <span
                  [class.placeholder]="
                    !selectedStatus?.value && selectedStatus?.value !== ''
                  "
                >
                  {{ selectedStatus?.name || "เลือกสถานะ" }}
                </span>
                <mat-icon class="dropdown-arrow">expand_more</mat-icon>
              </button>
              <div class="dropdown-panel" [class.open]="opened['status']">
                <button
                  type="button"
                  *ngFor="let s of statusOptions"
                  class="dropdown-option"
                  (click)="selectStatus(s)"
                >
                  <div class="selected-item">
                    <span>{{ s.name }}</span>
                  </div>
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="action-row">
          <div class="grow"></div>
          <button color="primary" type="submit" class="btn">ค้นหา</button>
          <button
            mat-stroked-button
            type="button"
            class="button-clear"
            (click)="clear()"
          >
            เคลียร์
          </button>
        </div>
      </form>
    </div>
  </div>

  <div class="table-card">
    <div class="table-responsive">
      <table>
        <thead>
          <tr>
            <th class="checkbox">
              <input type="checkbox" (change)="toggleAll()" color="primary" />
            </th>
            <th
              class="text-left sortable"
              (click)="onSort('docNo')"
              title="เรียงลำดับ"
            >
              เลขที่เอกสาร
              <span class="sort-icon-wrapper">
                <i
                  class="ti ti-caret-up-filled"
                  [class.active]="sortBy === 'docNo' && sortDir === 'asc'"
                ></i>
                <i
                  class="ti ti-caret-down-filled"
                  [class.active]="sortBy === 'docNo' && sortDir === 'desc'"
                ></i>
              </span>
            </th>
            <th
              class="text-left sortable"
              (click)="onSort('taxId')"
              title="เรียงลำดับ"
            >
              เลขที่ผู้เสียภาษี
              <span class="sort-icon-wrapper">
                <i
                  class="ti ti-caret-up-filled"
                  [class.active]="sortBy === 'taxId' && sortDir === 'asc'"
                ></i>
                <i
                  class="ti ti-caret-down-filled"
                  [class.active]="sortBy === 'taxId' && sortDir === 'desc'"
                ></i>
              </span>
            </th>
            <th
              class="text-left sortable"
              (click)="onSort('buyerName')"
              title="เรียงลำดับ"
            >
              ชื่อผู้ซื้อ
              <span class="sort-icon-wrapper">
                <i
                  class="ti ti-caret-up-filled"
                  [class.active]="sortBy === 'buyerName' && sortDir === 'asc'"
                ></i>
                <i
                  class="ti ti-caret-down-filled"
                  [class.active]="sortBy === 'buyerName' && sortDir === 'desc'"
                ></i>
              </span>
            </th>
            <th class="text-center">รหัสสาขา</th>
            <th class="text-center">ประเภทเอกสาร</th>
            <th
              class="text-left sortable"
              (click)="onSort('issueDate')"
              title="เรียงลำดับ"
            >
              วันที่ออกเอกสาร
              <span class="sort-icon-wrapper">
                <i
                  class="ti ti-caret-up-filled"
                  [class.active]="sortBy === 'issueDate' && sortDir === 'asc'"
                ></i>
                <i
                  class="ti ti-caret-down-filled"
                  [class.active]="sortBy === 'issueDate' && sortDir === 'desc'"
                ></i>
              </span>
            </th>
            <th
              class="text-left sortable"
              (click)="onSort('createdAt')"
              title="เรียงลำดับ"
            >
              วันที่สร้างเอกสาร
              <span class="sort-icon-wrapper">
                <i
                  class="ti ti-caret-up-filled"
                  [class.active]="sortBy === 'createdAt' && sortDir === 'asc'"
                ></i>
                <i
                  class="ti ti-caret-down-filled"
                  [class.active]="sortBy === 'createdAt' && sortDir === 'desc'"
                ></i>
              </span>
            </th>
            <th
              class="text-center sortable"
              (click)="onSort('status')"
              title="เรียงลำดับ"
            >
              สถานะเอกสาร
              <span class="sort-icon-wrapper">
                <i
                  class="ti ti-caret-up-filled"
                  [class.active]="sortBy === 'status' && sortDir === 'asc'"
                ></i>
                <i
                  class="ti ti-caret-down-filled"
                  [class.active]="sortBy === 'status' && sortDir === 'desc'"
                ></i>
              </span>
            </th>
            <th class="text-center">การดำเนินการ</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let r of paginatedRows">
            <td class="text-center"><input type="checkbox" /></td>
            <td class="text-left">{{ r.docNo }}</td>
            <td class="text-left">
              {{
                r.buyerTaxId ||
                  r.buyerTaxIdSnapshot ||
                  r.buyerPassportNoSnapshot
              }}
            </td>
            <td class="text-left">{{ r.buyerName || r.buyerNameSnapshot }}</td>
            <td class="text-center">{{ r.branchCode }}</td>
            <td class="text-center">{{ getDocTypeName(r.docTypeCode) }}</td>
            <td class="text-left">
              {{ r.issueDate | thaiDate : "dd/MM/yyyy HH:mm:ss" }}
            </td>
            <td class="text-left">
              {{ r.createdAt | thaiDate : "dd/MM/yyyy HH:mm:ss" }}
            </td>
            <td class="text-center">
              <span class="status" [ngClass]="getStatusClass(r.status)">
                {{ getStatusText(r.status) }}
              </span>
            </td>
            <td class="actions text-center">
              <ng-container *hasPermission="'DOC_VIEW'">
                <button
                  mat-icon-button
                  class="icon-view"
                  title="ดู"
                  (click)="viewDocument(r.docUuid)"
                >
                  <i class="ti ti-eye"></i>
                </button>
              </ng-container>

              <ng-container *hasPermission="'DOC_EDIT'">
                <button
                  mat-icon-button
                  class="icon-edit"
                  title="แก้ไข"
                  (click)="editDocument(r.docUuid)"
                  *ngIf="r.status !== 'CANCELLED'"
                >
                  <i class="ti ti-edit"></i>
                </button>
              </ng-container>

              <ng-container *hasPermission="'DOC_EXPORT'">
                <button
                  mat-icon-button
                  class="icon-view"
                  title="ดาวน์โหลด"
                  (click)="openDownloadModal(r.docUuid, r.docNo)"
                >
                  <i class="ti ti-download"></i>
                </button>
              </ng-container>

              <ng-container *hasPermission="'DOC_CANCEL'">
                <button
                  mat-icon-button
                  class="icon-delete"
                  title="ยกเลิก"
                  (click)="cancelInvoice(r.docUuid)"
                  *ngIf="r.status !== 'CANCELLED'"
                >
                  <i class="ti ti-ban"></i>
                </button>
              </ng-container>

              <ng-container *hasPermission="'DOC_DELETE'">
                <button
                  mat-icon-button
                  class="icon-delete"
                  title="ลบ"
                  (click)="deleteDocument(r.docUuid)"
                  *ngIf="r.status !== 'CANCELLED'"
                >
                  <i class="ti ti-trash"></i>
                </button>
              </ng-container>
            </td>
          </tr>
          <tr *ngIf="rows.length === 0">
            <td colspan="10" class="no-data">ไม่พบข้อมูลเอกสาร</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="pagination">
      <div class="pagination-left">
        <div class="items-per-page">
          <span>แสดง</span>
          <select
            (change)="onItemsPerPageChange($event)"
            [value]="itemsPerPage"
          >
            <option value="10">10</option>
            <option value="20">20</option>
            <option value="50">50</option>
          </select>
          <span>รายการ</span>
        </div>

        <div class="pagination-info">
          แสดง {{ startItemIndex }} ถึง {{ endItemIndex }} จาก
          {{ rows.length }} รายการ
        </div>
      </div>

      <div class="pagination-controls">
        <div class="page-number">
          <button
            (click)="onPageChange(currentPage - 1)"
            [disabled]="currentPage === 1"
          >
            <mat-icon>chevron_left</mat-icon>
          </button>

          <button
            *ngFor="let page of pages"
            (click)="onPageChange(page)"
            [class.active]="currentPage === page"
          >
            {{ page }}
          </button>

          <button
            (click)="onPageChange(currentPage + 1)"
            [disabled]="currentPage === totalPages"
          >
            <mat-icon>chevron_right</mat-icon>
          </button>
        </div>
      </div>
    </div>
  </div>
</section>
